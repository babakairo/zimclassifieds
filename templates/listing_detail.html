{% extends "base.html" %}

{% block title %}{{ listing.title }} - ZimClassifieds{% endblock %}

{% block content %}
<style>
    .listing-detail {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
    }

    .listing-images {
        background: #f0f0f0;
        border-radius: 8px;
        padding: 0;
        text-align: center;
        overflow: hidden;
    }

    .main-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        display: block;
    }

    .image-thumbnails {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        background: white;
        overflow-x: auto;
    }

    .thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s;
    }

    .thumbnail.active, .thumbnail:hover {
        border-color: #3b82f6;
    }

    .listing-info {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .listing-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    .seller-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 1rem 0;
    }

    .seller-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 0.5rem;
    }

    .seller-rating {
        color: #ff9800;
        margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
        .listing-detail {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="listing-detail">
    <div>
        <div class="listing-images">
            {% if listing_images %}
                <img id="mainImage" src="/static/{{ listing_images[0] }}" alt="{{ listing.title }}" class="main-image">
                {% if listing_images|length > 1 %}
                <div class="image-thumbnails">
                    {% for image in listing_images %}
                    <img src="/static/{{ image }}" alt="Thumbnail" class="thumbnail {% if loop.first %}active{% endif %}" 
                         onclick="changeImage(this)">
                    {% endfor %}
                </div>
                {% endif %}
            {% else %}
                <div style="padding: 2rem; font-size: 80px;">
                    {% if listing.category == 'products' %}
                        üì¶
                    {% elif listing.category == 'services' %}
                        üîß
                    {% elif listing.category == 'jobs' %}
                        üíº
                    {% elif listing.category == 'real_estate' %}
                        üè†
                    {% else %}
                        üí≠
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <div class="card" style="margin-top: 2rem;">
            <h3>About This Listing</h3>
            <p>{{ listing.description }}</p>

            <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #eee;">
                <p><strong>Posted:</strong> {{ listing.created_at[:10] }}</p>
                <p><strong>Last Bumped:</strong> {{ listing.bumped_at[:10] if listing.bumped_at else listing.created_at[:10] }}</p>
                <p><strong>Views:</strong> {{ listing.views }}</p>
                <p><strong>Location:</strong> {{ listing.location_suburb }}, {{ listing.location_city }}</p>
                <p><strong>Category:</strong> {{ listing.category }} > {{ listing.subcategory }}</p>
            </div>
        </div>
    </div>

    <div>
        <div class="listing-info">
            <div class="listing-header">
                <h2 style="color: #059669; margin-bottom: 0;">
                    {% if listing.price %}
                    ZWL {{ "{:,.0f}".format(listing.price) }}
                    {% else %}
                    Contact for price
                    {% endif %}
                </h2>
            </div>

            <h1 style="font-size: 20px; margin-bottom: 1rem;">{{ listing.title }}</h1>

            {% if session.get('user_id') == listing.user_id %}
                <div style="display: grid; gap: 0.5rem;">
                    <a href="/listing/{{ listing.listing_id }}/edit" class="btn btn-secondary">‚úèÔ∏è Edit</a>
                    <button onclick="bumpListing('{{ listing.listing_id }}')" class="btn" style="background: #f59e0b; color: white;">‚¨ÜÔ∏è Bump to Top</button>
                    <button onclick="deleteListing('{{ listing.listing_id }}')" class="btn btn-danger">üóëÔ∏è Delete</button>
                </div>
            {% else %}
                <div style="display: grid; gap: 0.5rem;">
                    {% if session.get('user_id') %}
                        <a href="/message/{{ seller.user_id }}" class="btn btn-primary">üí¨ Message Seller</a>
                        <button onclick="toggleFavorite('{{ listing.listing_id }}')" id="fav-btn" class="btn btn-secondary">
                            {% if is_favorite %}‚≠ê Remove from Favorites{% else %}‚òÜ Add to Favorites{% endif %}
                        </button>
                    {% else %}
                        <a href="/login" class="btn btn-primary">Login to Message</a>
                        <a href="/register" class="btn btn-secondary">Create Account</a>
                    {% endif %}
                </div>

                <button onclick="flagListing('{{ listing.listing_id }}')" style="margin-top: 1rem; width: 100%; background: #f0f0f0; color: #666; border: none; padding: 10px; border-radius: 6px; cursor: pointer;">
                    üö® Report Listing
                </button>
            {% endif %}

            {% if seller %}
            <div class="seller-card">
                <div class="seller-name">üì± {{ seller.full_name }}</div>
                <div class="seller-rating">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                {% if seller.phone %}
                <p>üìû <a href="tel:{{ seller.phone }}" style="color: #1e40af;">{{ seller.phone }}</a></p>
                {% endif %}
                <a href="/profile/{{ seller.user_id }}" class="btn btn-secondary" style="width: 100%; margin-top: 1rem; text-align: center;">View Profile</a>
            </div>
            {% endif %}

            <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; margin-top: 2rem; font-size: 14px;">
                <strong>‚ö†Ô∏è Safety Tips:</strong>
                <ul style="margin: 0.5rem 0 0 1.5rem;">
                    <li>Meet in a safe public place</li>
                    <li>Check the condition before payment</li>
                    <li>Don't send money in advance</li>
                    <li>Report suspicious activity</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleFavorite(listingId) {
        fetch(`/api/favorite/${listingId}`, {
            method: 'POST'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const btn = document.getElementById('fav-btn');
                if (data.action === 'added') {
                    btn.textContent = '‚≠ê Remove from Favorites';
                } else {
                    btn.textContent = '‚òÜ Add to Favorites';
                }
                showAlert(`Listing ${data.action}!`);
            }
        });
    }

    function flagListing(listingId) {
        const reason = prompt('Why are you reporting this listing?');
        if (reason) {
            fetch(`/api/flag-listing/${listingId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({reason: reason})
            })
            .then(r => r.json())
            .then(data => showAlert(data.message));
        }
    }

    function bumpListing(listingId) {
        fetch(`/api/bump-listing/${listingId}`, {
            method: 'POST'
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                showAlert(data.message || 'Error bumping listing');
            }
        });
    }

    function deleteListing(listingId) {
        if (confirm('Are you sure you want to delete this listing?')) {
            fetch(`/listing/${listingId}/delete`, {
                method: 'POST'
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/dashboard';
                }
            });
        }
    }
</script>
{% endblock %}
