{% extends "base.html" %}

{% block title %}Create Listing - ZimClassifieds{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">
    <div class="card">
        <h2 style="margin-bottom: 2rem; color: #1e3a8a;">Post Your Ad</h2>

        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}

        <form method="post" enctype="multipart/form-data">
            <p style="color: #0f172a; font-weight: 600;">Post for free â€” listings are free during our launch period.</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" name="category" onchange="updateSubcategories()" required>
                        <option value="">Select Category</option>
                        {% for cat in categories.keys()|sort %}
                        <option value="{{ cat }}">{{ cat.replace('_', ' ').title() }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="subcategory">Type *</label>
                    <select id="subcategory" name="subcategory" required>
                        <option value="">Select Category First</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="title">Title *</label>
                <input type="text" id="title" name="title" placeholder="e.g., Samsung 55-inch TV" required>
            </div>

            <div class="form-group">
                <label for="description">Description *</label>
                <textarea id="description" name="description" placeholder="Describe your item or service..." required></textarea>
            </div>

            <div class="form-group">
                <label for="images">ðŸ“· Upload Images (Max 5 per listing, up to 5MB each)</label>
                <input type="file" id="images" name="images" multiple accept="image/*" style="padding: 8px; border: 2px dashed #3b82f6; border-radius: 8px; cursor: pointer;">
                <div id="image-preview" style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem;"></div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label for="location_city">City *</label>
                    <select id="location_city" name="location_city" onchange="updateSuburbs()" required>
                        <option value="">Select City</option>
                        {% for city in locations.keys()|sort %}
                        <option value="{{ city }}">{{ city }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="location_suburb">Suburb/Area *</label>
                    <select id="location_suburb" name="location_suburb" required>
                        <option value="">Select City First</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="price">Price (ZWL)</label>
                <input type="number" id="price" name="price" step="0.01" placeholder="Optional">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; padding: 12px;">Post Ad</button>
            {% if recaptcha_site_key %}
            <div style="margin-top: 1rem; text-align: center;">
                <script src="https://www.google.com/recaptcha/api.js" async defer></script>
                <div class="g-recaptcha" data-sitekey="{{ recaptcha_site_key }}"></div>
            </div>
            {% endif %}
        </form>
    </div>
</div>

<script>
    const categoriesData = {{ categories | tojson }};
    const locationsData = {{ locations | tojson }};

    // Image preview
    document.getElementById('images').addEventListener('change', function(e) {
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '';
        const maxFiles = 5;
        
        if (this.files.length > maxFiles) {
            alert(`Maximum ${maxFiles} images allowed`);
            this.value = '';
            return;
        }
        
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb;';
                preview.appendChild(img);
            };
            
            reader.readAsDataURL(file);
        }
    });

    function updateSubcategories() {
        const category = document.getElementById('category').value;
        const subcategorySelect = document.getElementById('subcategory');
        
        subcategorySelect.innerHTML = '<option value="">Select Type</option>';
        
        if (category && categoriesData[category]) {
            categoriesData[category].forEach(sub => {
                const option = document.createElement('option');
                option.value = sub;
                option.textContent = sub;
                subcategorySelect.appendChild(option);
            });
        }
    }

    function updateSuburbs() {
        const city = document.getElementById('location_city').value;
        const suburbSelect = document.getElementById('location_suburb');
        
        suburbSelect.innerHTML = '<option value="">Select Suburb</option>';
        
        if (city && locationsData[city]) {
            locationsData[city].forEach(suburb => {
                const option = document.createElement('option');
                option.value = suburb;
                option.textContent = suburb;
                suburbSelect.appendChild(option);
            });
        }
    }
</script>
{% endblock %}
